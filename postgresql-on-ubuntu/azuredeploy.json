{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "West US",
      "metadata": {
        "Description": "Location of the resource group and all contained resources"
      }
    },
    "newStorageAccountName": {
      "type": "string",
      "metadata": {
        "Description": "Unique name of the new storage account that will be created to store virtual machine VHDs"
      }
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "Description": "Domain name of the publicly accessible Apache server"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "Description": "Virtual machine administrator username"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "Description": "Virtual machine administrator password"
      }
    },
    "replicatorPassword": {
      "type": "string"
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_A1",
      "allowedValues": [
        "Standard_A1",
        "Standard_A2",
        "Standard_A3",
        "Standard_A4"
      ],
      "metadata": {
        "Description": "Size of the virtual machine (must be able to support 2 data disks)"
      }
    },
    "numberOfSlaveInstances": {
      "type": "int",
      "defaultValue": 1,
      "allowedValues": [
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10,
        11,
        12,
        13,
        14,
        15,
        16,
        17,
        18
      ],
      "metadata": {
        "Description": "Number of PostgreSQL slave instances to provision"
      }
    },
    "dbMasterName": {
      "type": "string",
      "defaultValue": "dbmaster"
    },
    "dbSlaveNamePrefix": {
      "type": "string",
      "defaultValue": "dbslave"
    },
    "dbAvailabilitySetName": {
      "type": "string",
      "defaultValue": "dbavailabilityset",
      "metadata": {
        "Description": "Name of the availability set containing the PostgreSQL master and slave database servers"
      }
    },
    "platformFaultDomainCount": {
      "type": "string",
      "defaultValue": "2"
    },
    "platformUpdateDomainCount": {
      "type": "string",
      "defaultValue": "5"
    },
    "dataDiskSizeGB": {
      "type": "string",
      "defaultValue": "1000"
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "vnet",
      "metadata": {
        "Description": "Virtual network name"
      }
    },
    "addressPrefix": {
      "type": "string",
      "defaultValue": "10.1.0.0/16"
    },
    "subnetDmzName": {
      "type": "string",
      "defaultValue": "Subnet-DMZ"
    },
    "subnetDmzPrefix": {
      "type": "string",
      "defaultValue": "10.1.0.0/24"
    },
    "subnetDbName": {
      "type": "string",
      "defaultValue": "Subnet-DB"
    },
    "subnetDbPrefix": {
      "type": "string",
      "defaultValue": "10.1.1.0/24"
    }
  },
  "variables": {
    "sourceImageName": "[concat('/',subscription().subscriptionId,'/services/images/',variables('vmSourceImageName'))]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
    "subnetDmzRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetDmzName'))]",
    "subnetDbRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetDbName'))]",
    
    "osSettings": {
      "scripts": [
      "https://raw.githubusercontent.com/azurermtemplates/azurermtemplates/master/postgresql-multi-vm-ubuntu/install_postgresql.sh",
      "https://raw.githubusercontent.com/azurermtemplates/azurermtemplates/master/shared_scripts/ubuntu/vm-disk-utils-0.1.sh"
      ],
      "vmSourceImageName": "b39f27a8b8c64d52b05eac6a62ebad85__Ubuntu-14_04_2_LTS-amd64-server-20150309-en-us-30GB"
    },
    "commandToExecute": "[concat('bash install_postgresql.sh ', reference('nicmaster').ipConfigurations[0].properties.privateIPAddress, ' ', parameters('subnetDbPrefix'), ' SLAVE ', reference(concat('nicslave', copyindex())).ipConfigurations[0].properties.privateIPAddress, ' ', parameters('numberOfSlaveInstances'), ' ', parameters('replicatorPassword'))]",
    "networkSettings": {
      "vnetName": "trent",
      "addressPrefix": "10.0.0.0/16",
      "subnets": {
        "dmz": {
          "name": "dmz",
          "prefix": "10.0.0.0/24",
          "vnet": "trent"
        },
        "data": {
          "name": "data",
          "prefix": "10.0.1.0/24",
          "vnet": "trent"
        }
    },
    "availabilitySetSettings": {
        "name": "dbAvailabilitySet",
        "fdCount": 3,
        "udCount": 20
      }
  }
  },
  "resources": [
    
  ],
  "outputs": {}
}